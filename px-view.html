<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. ui tests, examples), we assume the server is started with
    'grunt depserve' (or similar server setup) to enable correct finding of bower dependencies for local runs.
-->
<link rel="import" href="../bower_components/polymer/polymer.html">

<!-- Carbon Route and Carbon Locatiion are used for routing -->
<link rel="import" href="../bower_components/carbon-route/carbon-location.html" />
<link rel="import" href="../bower_components/carbon-route/carbon-route.html" />

<!--
Element providing solution to no problem in particular. As a simple, increments a counter when clicked.

##### Usage

    <px-view counter-value="1">Hi</px-view>

@element px-view
@blurb Element providing solution to no problem in particular.
@homepage index.html
@demo demo.html
-->
<dom-module id="px-view">
  <link rel="import" type="css" href="css/px-view.css"/>
  <template>
    <carbon-location route="{{route}}" use-hash-as-path></carbon-location>
    <carbon-route route="{{route}}" pattern="[[pattern]]" active="{{active}}"></carbon-route>
    <!-- view element will be inserted here -->
  </template>
</dom-module>

<script>
  Polymer({
    is: 'px-view',
    properties: {
      /**
       *
       * Set the 'preload' attribute on the <px-view> element and the components will be
       * loaded immediately or
       * lazy-loaded on demand. Lazy-loading is on by default to avoid unnecessary HTTP requests.
       *
       * @attribute preload
       * @type Boolean
       * @default false
      */
      preload: {
        type: Boolean,
        value: false
      },
      /**
       *
       * Status tracks a px-view component over it's lifecycle
       * Steps: 'unloaded' -> 'loading' -> 'loaded' || 'failed' -> 'attached' -> 'hidden' || 'shown'
       *
       * @attribute status
       * @type String
       * @readonly
       * @access public
      */
      status: {
        type: String,
        value: 'unloaded',
        notify: true,
        reflectToAttribute: true
      },
      /**
       *
       * elementTagName sets the name of the tag to attach to the DOM which must match component name
       *
       * @attribute elementTagName
       * @type String
       * @access public
      */
      elementTagName: {
        type: String,
        value: ""
      },
      /**
       *
       * elementHref defines relative URL path of web component html file
       *
       * @attribute elementHref
       * @type String
       * @access public
      */
      elementHref: {
        type: String,
        value: ""
      },
      /**
       *
       * The display property defines the value of the component's display property when view is shown
       *
       * @attribute elementHref
       * @type String
       * @access public
       * @default 'block'
      */
      display: {
        type: String,
        value: "block"
      }
    },

    observers: [
      '_checkStatus(status, active, preload, elementTagName, elementHref, display)'
    ],

    viewElement: null, // Reference to the loaded view DOM element

    // 'unloaded' -> 'loading' -> 'loaded' || 'failed' -> 'attached' -> 'hidden' || 'shown'
    _checkStatus: function() {
      switch (this.status) {
        case 'unloaded':
          if (this.active || this.preload) {
            this._loadElement();
          };
          break;
        case 'loading':
          break;
        case 'loaded':
          if (this.active) {
            this._attachElement();
          };
          break;
        case 'attached':
          var newStatus = this.active ? 'shown' : 'hidden';
          this.set('status', newStatus);
          break;
        case 'shown':
          if (this.active) {
            this.viewElement.style.display = this.display;
          } else {
            this.set('status', 'hidden');
          }
          break;
        case 'hidden':
          if (!this.active) {
            this.viewElement.style.display = 'none';
          } else {
            this.set('status', 'shown');
          }
          break;
        default:
          console.log('px-view status has entered unknown state: ', this.status);
      }
    },

    _attachElement: function() {
      this.viewElement = document.createElement(this.elementTagName);
      this.appendChild(this.viewElement);
      this.set('status', 'attached');
    },

    _loadElement: function() {
      this.set('status', 'loading');
      this.importHref(this.elementHref, function(e) {
        this.set('status', 'loaded');
      }, function(e) {
        console.log('Failure to load ' + this.elementHref);
        this.set('status', 'failed');
      });
    }

  });
</script>
