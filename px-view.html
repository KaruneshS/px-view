<!--
    Relative paths assume component is being run from inside an app or another component, where dependencies are flat
    siblings. When this component is run from its own repo (e.g. ui tests, examples), we assume the server is started with
    'grunt depserve' (or similar server setup) to enable correct finding of bower dependencies for local runs.
-->
<link rel="import" href="../polymer/polymer.html"/>

<dom-module id="px-view">
  <template>
    <!-- insert element here -->
  </template>
  <script>
    'use strict';

    Polymer({

      is: 'px-view',

      properties: {
        /**
         *
         * Set the 'active' attribute on the <px-view> element to true and the components will be
         * loaded and displayed
         *
         * @attribute preload
         * @type Boolean
         * @default false
        */
        active: {
          type: Boolean,
          value: false
        },
        /**
         *
         * Set the 'preload' attribute on the <px-view> element and the components will be
         * loaded immediately or
         * lazy-loaded on demand. Lazy-loading is on by default to avoid unnecessary HTTP requests.
         *
         * @attribute preload
         * @type Boolean
         * @default false
        */
        preload: {
          type: Boolean,
          value: false
        },
        /**
         *
         * Status tracks a px-view component over it's lifecycle
         * Steps: 'unloaded' -> 'loading' -> 'loaded' || 'failed' -> 'attached' -> 'hidden' || 'shown'
         *
         * @attribute status
         * @type String
         * @readonly
         * @access public
        */
        status: {
          type: String,
          value: 'unloaded',
          notify: true,
          reflectToAttribute: true
        },
        /**
         *
         * elementTagName sets the name of the tag to attach to the DOM which must match component name
         *
         * @attribute elementTagName
         * @type String
         * @access private
        */
        _elementTagName: {
          type: String,
          computed: '_computeElementTagName(elementHref)'
        },
        /**
         *
         * elementHref defines relative URL path of web component html file
         *
         * @attribute elementHref
         * @type String
         * @access public
        */
        elementHref: {
          type: String
        },
        /**
         *
         * The display property defines the value of the component's display property when view is shown
         *
         * @attribute elementHref
         * @type String
         * @access public
         * @default 'block'
        */
        display: {
          type: String,
          value: "block"
        },

        _importLink: {
          type: Object,
          value: function() { return {} }
        }

      },

      observers: [
        '_checkStatus(status, active, preload, elementHref, display, _elementTagName)',
      ],

      _viewElement: null, // Reference to the loaded view DOM element

      // when state is 'unloaded', if active or preload are true, start loading
      _onUnloaded: function() {
        if (this.active || this.preload) {
          this._loadElement();
        }
      },

      _onLoading: function() {
        // do nothing
      },

      // when state is 'loaded', if active, attach element to DOM
      _onLoaded: function() {
        if (this.active) {
          this._attachElement();
        }
      },

      // when state is 'attached', if active, set status to 'shown', otherwise 'hidden'
      _onAttached: function() {
        var newStatus = this.active ? 'shown' : 'hidden';
        this.set('status', newStatus);
      },

      // when state is 'shown', if active, set element display property
      _onShown: function() {
        if (this.active) {
          this._viewElement.style.display = this.display;
        } else {
          this.set('status', 'hidden');
        }
      },

      // when state is 'hidden', if active, set element display property to 'none'
      _onHidden: function() {
        if (!this.active) {
          this._viewElement.style.display = 'none';
        } else {
          this.set('status', 'shown');
        }
      },

      // _stateFunctions is an object literal with references to functions
      // this maps state string values to state functions
      _getStateFunction: function(status) {
        var stateFunctions = {
          'unloaded': this._onUnloaded,
          'loading': this._onLoading,
          'loaded': this._onLoaded,
          'attached': this._onAttached,
          'shown': this._onShown,
          'hidden': this._onHidden
        };
        return stateFunctions[status];
      },

      // 'unloaded' -> 'loading' -> 'loaded' || 'failed' -> 'attached' -> 'hidden' || 'shown'
      _checkStatus: function() {
        // lookup state function and call it using fn.apply to maintain scope
        this._getStateFunction(this.status).apply(this);
      },

      _attachElement: function() {
        // confirm element tag name matches loaded element
        this._viewElement = document.createElement(this._elementTagName);
        this._viewElement.id = this._elementTagName + '-' + new Date().getTime();
        this.appendChild(this._viewElement);
        this.set('status', 'attached');
      },

      _loadElement: function() {
        this.set('status', 'loading');
        this._importLink = this.importHref(this.elementHref, function(e) {
          // confirm loaded dom-module id matches _elementTagName
          var moduleId = this._importLink.import.querySelector('dom-module').id;
          if(moduleId === this._elementTagName) {
            this.set('status', 'loaded');
          } else {
            console.log('Error: dom-module of imported element does not match element tag name');
            this.set('status', 'failed');
          }

        }, function(error) {
          this.set('status', 'failed');
        });
      },

      _computeElementTagName: function() {
        var filenameRegex = /(?=([\w-]+)\.\w{3,4}$).+/;
        var match;
        if ((match = filenameRegex.exec(this.elementHref)) !== null) {
          if (match.index === filenameRegex.lastIndex) {
            filenameRegex.lastIndex++;
          }
        }
        return match[1];
      }

    });
  </script>
</dom-module>
